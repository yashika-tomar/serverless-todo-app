{"filter":false,"title":"generateUploadUrl.js","tooltip":"/project final initial/cd12101-Deploy-Application-with-AWS-Lambda/starter/backend/src/lambda/http/generateUploadUrl.js","undoManager":{"mark":5,"position":5,"stack":[[{"start":{"row":0,"column":0},"end":{"row":7,"column":0},"action":"remove","lines":["export function handler(event) {","  const todoId = event.pathParameters.todoId","","  // TODO: Return a presigned URL to upload a file for a TODO item with the provided id","  return undefined","}","",""],"id":2},{"start":{"row":0,"column":0},"end":{"row":36,"column":1},"action":"insert","lines":["import AWS from 'aws-sdk'","import { createLogger } from '../../utils/logger.mjs'","","const logger = createLogger('todos')","const s3 = new AWS.S3({ signatureVersion: 'v4' })","const bucketName = process.env.ATTACHMENTS_BUCKET","const urlExpiration = process.env.URL_EXPIRATION || 300 // default 5 minutes","","export async function handler(event) {","  const todoId = event.pathParameters.todoId","  const userId = event.requestContext.authorizer.userId","","  try {","    const attachmentKey = `${todoId}.jpg` // or adjust based on your file type","","    // Generate presigned URL","    const uploadUrl = s3.getSignedUrl('putObject', {","      Bucket: bucketName,","      Key: attachmentKey,","      Expires: Number(urlExpiration)","    })","","    logger.info('Generated upload URL', { todoId, userId, uploadUrl })","","    return {","      statusCode: 200,","      body: JSON.stringify({ uploadUrl })","    }","  } catch (error) {","    logger.error('Error generating upload URL', { error })","","    return {","      statusCode: 500,","      body: JSON.stringify({ error: 'Could not generate upload URL' })","    }","  }","}"]}],[{"start":{"row":25,"column":22},"end":{"row":26,"column":0},"action":"insert","lines":["",""],"id":3},{"start":{"row":26,"column":0},"end":{"row":26,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":26,"column":6},"end":{"row":30,"column":0},"action":"insert","lines":["headers: {","  \"Access-Control-Allow-Origin\": \"*\",","  \"Access-Control-Allow-Credentials\": true","},",""],"id":4}],[{"start":{"row":37,"column":22},"end":{"row":38,"column":0},"action":"insert","lines":["",""],"id":5},{"start":{"row":38,"column":0},"end":{"row":38,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":38,"column":6},"end":{"row":42,"column":0},"action":"insert","lines":["headers: {","  \"Access-Control-Allow-Origin\": \"*\",","  \"Access-Control-Allow-Credentials\": true","},",""],"id":6}],[{"start":{"row":0,"column":0},"end":{"row":46,"column":1},"action":"remove","lines":["import AWS from 'aws-sdk'","import { createLogger } from '../../utils/logger.mjs'","","const logger = createLogger('todos')","const s3 = new AWS.S3({ signatureVersion: 'v4' })","const bucketName = process.env.ATTACHMENTS_BUCKET","const urlExpiration = process.env.URL_EXPIRATION || 300 // default 5 minutes","","export async function handler(event) {","  const todoId = event.pathParameters.todoId","  const userId = event.requestContext.authorizer.userId","","  try {","    const attachmentKey = `${todoId}.jpg` // or adjust based on your file type","","    // Generate presigned URL","    const uploadUrl = s3.getSignedUrl('putObject', {","      Bucket: bucketName,","      Key: attachmentKey,","      Expires: Number(urlExpiration)","    })","","    logger.info('Generated upload URL', { todoId, userId, uploadUrl })","","    return {","      statusCode: 200,","      headers: {","  \"Access-Control-Allow-Origin\": \"*\",","  \"Access-Control-Allow-Credentials\": true","},","","      body: JSON.stringify({ uploadUrl })","    }","  } catch (error) {","    logger.error('Error generating upload URL', { error })","","    return {","      statusCode: 500,","      headers: {","  \"Access-Control-Allow-Origin\": \"*\",","  \"Access-Control-Allow-Credentials\": true","},","","      body: JSON.stringify({ error: 'Could not generate upload URL' })","    }","  }","}"],"id":7},{"start":{"row":0,"column":0},"end":{"row":49,"column":0},"action":"insert","lines":["import AWS from 'aws-sdk'","import { createLogger } from '../../utils/logger.mjs'","","const logger = createLogger('todos')","const s3 = new AWS.S3({ signatureVersion: 'v4' })","const bucketName = process.env.ATTACHMENTS_BUCKET","const urlExpiration = process.env.URL_EXPIRATION || 300 // default 5 minutes","","export async function handler(event) {","  const todoId = event.pathParameters.todoId","","  // FIX: use principalId (the actual user ID)","  const userId = event.requestContext.authorizer.principalId","","  try {","    // Use a stable key format: userId/todoId","    const attachmentKey = `${userId}/${todoId}`","","    // Generate presigned S3 URL","    const uploadUrl = s3.getSignedUrl('putObject', {","      Bucket: bucketName,","      Key: attachmentKey,","      Expires: Number(urlExpiration)","    })","","    logger.info('Generated upload URL', { todoId, userId })","","    return {","      statusCode: 200,","      headers: {","        \"Access-Control-Allow-Origin\": \"*\",","        \"Access-Control-Allow-Credentials\": true","      },","      body: JSON.stringify({ uploadUrl })","    }","","  } catch (error) {","    logger.error('Error generating upload URL', { error })","","    return {","      statusCode: 500,","      headers: {","        \"Access-Control-Allow-Origin\": \"*\",","        \"Access-Control-Allow-Credentials\": true","      },","      body: JSON.stringify({ error: 'Could not generate upload URL' })","    }","  }","}",""]}]]},"ace":{"folds":[],"scrolltop":457,"scrollleft":0,"selection":{"start":{"row":41,"column":16},"end":{"row":41,"column":16},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":31,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1763838689008,"hash":"28857bfa76a16ce13ab96f194bd956b5ca803917"}