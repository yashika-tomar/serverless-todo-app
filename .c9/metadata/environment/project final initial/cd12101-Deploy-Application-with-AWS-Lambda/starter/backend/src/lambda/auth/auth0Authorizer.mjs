{"filter":false,"title":"auth0Authorizer.mjs","tooltip":"/project final initial/cd12101-Deploy-Application-with-AWS-Lambda/starter/backend/src/lambda/auth/auth0Authorizer.mjs","undoManager":{"mark":0,"position":0,"stack":[[{"start":{"row":0,"column":0},"end":{"row":71,"column":1},"action":"remove","lines":["import Axios from 'axios'","import jsonwebtoken from 'jsonwebtoken'","import { createLogger } from '../../utils/logger.mjs'","","const logger = createLogger('auth')","","// Replace with your Auth0 tenant domain","const jwksUrl = 'https://dev-swyiahy623v6dfat.us.auth0.com/.well-known/jwks.json'","","export async function handler(event) {","  try {","    const jwtToken = await verifyToken(event.authorizationToken)","","    return {","      principalId: jwtToken.sub,","      policyDocument: {","        Version: '2012-10-17',","        Statement: [","          {","            Action: 'execute-api:Invoke',","            Effect: 'Allow',","            Resource: '*'","          }","        ]","      }","    }","  } catch (e) {","    logger.error('User not authorized', { error: e.message })","","    return {","      principalId: 'user',","      policyDocument: {","        Version: '2012-10-17',","        Statement: [","          {","            Action: 'execute-api:Invoke',","            Effect: 'Deny',","            Resource: '*'","          }","        ]","      }","    }","  }","}","","async function verifyToken(authHeader) {","  const token = getToken(authHeader)","  const decodedJwt = jsonwebtoken.decode(token, { complete: true })","  if (!decodedJwt) throw new Error('Invalid JWT token')","","  const kid = decodedJwt.header.kid","  const jwks = await Axios.get(jwksUrl)","  const signingKey = jwks.data.keys.find(key => key.kid === kid)","","  if (!signingKey) throw new Error('Signing key not found')","","  // Construct certificate","  const pubKey = `-----BEGIN CERTIFICATE-----\\n${signingKey.x5c[0]}\\n-----END CERTIFICATE-----`","","  // Verify token signature","  return jsonwebtoken.verify(token, pubKey, { algorithms: ['RS256'] })","}","","function getToken(authHeader) {","  if (!authHeader) throw new Error('No authentication header')","","  if (!authHeader.toLowerCase().startsWith('bearer '))","    throw new Error('Invalid authentication header')","","  const split = authHeader.split(' ')","  return split[1]","}"],"id":2},{"start":{"row":0,"column":0},"end":{"row":82,"column":0},"action":"insert","lines":["import Axios from 'axios'","import jsonwebtoken from 'jsonwebtoken'","import { createLogger } from '../../utils/logger.mjs'","","const logger = createLogger('auth')","","const jwksUrl = `https://dev-swyiahy623v6dfat.us.auth0.com/.well-known/jwks.json`","const expectedIssuer = 'https://dev-swyiahy623v6dfat.us.auth0.com/'","const expectedAudience = 'https://todo-api-dev/'","","export async function handler(event) {","  try {","    const jwtToken = await verifyToken(event.authorizationToken)","","    // Additional audience + issuer verification","    if (jwtToken.iss !== expectedIssuer)","      throw new Error(`Invalid issuer: ${jwtToken.iss}`)","","    if (!jwtToken.aud || (Array.isArray(jwtToken.aud)","        ? !jwtToken.aud.includes(expectedAudience)","        : jwtToken.aud !== expectedAudience)","    ) {","      throw new Error(`Invalid audience: ${jwtToken.aud}`)","    }","","    return {","      principalId: jwtToken.sub,","      policyDocument: {","        Version: '2012-10-17',","        Statement: [","          {","            Action: 'execute-api:Invoke',","            Effect: 'Allow',","            Resource: '*'","          }","        ]","      }","    }","  } catch (e) {","    logger.error('User not authorized', { error: e.message })","","    return {","      principalId: 'user',","      policyDocument: {","        Version: '2012-10-17',","        Statement: [","          {","            Action: 'execute-api:Invoke',","            Effect: 'Deny',","            Resource: '*'","          }","        ]","      }","    }","  }","}","","async function verifyToken(authHeader) {","  const token = getToken(authHeader)","  const decodedJwt = jsonwebtoken.decode(token, { complete: true })","  if (!decodedJwt) throw new Error('Invalid JWT token')","","  const kid = decodedJwt.header.kid","  const jwks = await Axios.get(jwksUrl)","  const signingKey = jwks.data.keys.find(key => key.kid === kid)","","  if (!signingKey) throw new Error('Signing key not found')","","  const pubKey = `-----BEGIN CERTIFICATE-----\\n${signingKey.x5c[0]}\\n-----END CERTIFICATE-----`","","  return jsonwebtoken.verify(token, pubKey, { algorithms: ['RS256'] })","}","","function getToken(authHeader) {","  if (!authHeader) throw new Error('No authentication header')","","  if (!authHeader.toLowerCase().startsWith('bearer '))","    throw new Error('Invalid authentication header')","","  const split = authHeader.split(' ')","  return split[1]","}",""]}]]},"ace":{"folds":[],"scrolltop":690.4999754163936,"scrollleft":0,"selection":{"start":{"row":82,"column":0},"end":{"row":82,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":14,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1763829244292,"hash":"7e7c8a359b732fd83f8565e1d82537d8bc64aff8"}