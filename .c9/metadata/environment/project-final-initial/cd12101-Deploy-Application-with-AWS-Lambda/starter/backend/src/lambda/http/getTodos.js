{"filter":false,"title":"getTodos.js","tooltip":"/project-final-initial/cd12101-Deploy-Application-with-AWS-Lambda/starter/backend/src/lambda/http/getTodos.js","undoManager":{"mark":2,"position":2,"stack":[[{"start":{"row":13,"column":39},"end":{"row":13,"column":40},"action":"remove","lines":["y"],"id":2},{"start":{"row":13,"column":38},"end":{"row":13,"column":39},"action":"remove","lines":["r"]},{"start":{"row":13,"column":37},"end":{"row":13,"column":38},"action":"remove","lines":["e"]},{"start":{"row":13,"column":36},"end":{"row":13,"column":37},"action":"remove","lines":["u"]},{"start":{"row":13,"column":35},"end":{"row":13,"column":36},"action":"remove","lines":["q"]}],[{"start":{"row":13,"column":35},"end":{"row":13,"column":36},"action":"insert","lines":["s"],"id":3},{"start":{"row":13,"column":36},"end":{"row":13,"column":37},"action":"insert","lines":["c"]},{"start":{"row":13,"column":37},"end":{"row":13,"column":38},"action":"insert","lines":["a"]},{"start":{"row":13,"column":38},"end":{"row":13,"column":39},"action":"insert","lines":["n"]}],[{"start":{"row":0,"column":0},"end":{"row":47,"column":0},"action":"remove","lines":["import AWS from 'aws-sdk'","import { createLogger } from '../../utils/logger.mjs'","","const logger = createLogger('todos')","const docClient = new AWS.DynamoDB.DocumentClient()","const todosTable = process.env.TODOS_TABLE","","export async function handler(event) {","  // FIX: authorizer returns principalId, not userId","  const userId = event.requestContext.authorizer.principalId","","  try {","    // Query DynamoDB for all TODOs for the current user","    const result = await docClient.scan({","      TableName: todosTable,","      KeyConditionExpression: 'userId = :userId',","      ExpressionAttributeValues: {","        ':userId': userId","      }","    }).promise()","","    const items = result.Items","","    logger.info('Fetched TODOs', { userId, count: items.length })","","    return {","      statusCode: 200,","      headers: {","        \"Access-Control-Allow-Origin\": \"*\",","        \"Access-Control-Allow-Credentials\": true","      },","      body: JSON.stringify({ items })","    }","","  } catch (error) {","    logger.error('Error fetching TODOs', { error })","","    return {","      statusCode: 500,","      headers: {","        \"Access-Control-Allow-Origin\": \"*\",","        \"Access-Control-Allow-Credentials\": true","      },","      body: JSON.stringify({ error: 'Could not fetch TODOs' })","    }","  }","}",""],"id":4},{"start":{"row":0,"column":0},"end":{"row":97,"column":0},"action":"insert","lines":["// backend/src/lambda/http/getTodos.js","import AWS from 'aws-sdk'","import { createLogger } from '../../utils/logger.mjs'","","const logger = createLogger('getTodos')","const docClient = new AWS.DynamoDB.DocumentClient()","const TODOS_TABLE = process.env.TODOS_TABLE","const TODOS_CREATED_AT_INDEX = process.env.TODOS_CREATED_AT_INDEX","","export async function handler(event) {","  logger.info('getTodos invoked', { eventSummary: summarizeEvent(event) })","","  // Try to read userId from authorizer context (set by your custom authorizer)","  const userId =","    event?.requestContext?.authorizer?.userId ||","    event?.requestContext?.authorizer?.principalId ||","    event?.requestContext?.authorizer?.sub","","  if (!userId) {","    logger.error('No userId in requestContext.authorizer', {","      requestContext: event?.requestContext?.authorizer","    })","    return {","      statusCode: 401,","      headers: corsHeaders(),","      body: JSON.stringify({ error: 'Unauthorized: userId not found' })","    }","  }","","  // Build params for DynamoDB query","  const params = {","    TableName: TODOS_TABLE,","    KeyConditionExpression: 'userId = :userId',","    ExpressionAttributeValues: {","      ':userId': userId","    }","    // If you want to order/query by createdAt index, you can add IndexName:","    // IndexName: TODOS_CREATED_AT_INDEX","  }","","  try {","    logger.info('Querying DynamoDB', { paramsSummary: summarizeParams(params) })","    const result = await docClient.query(params).promise()","    const items = result.Items || []","    logger.info('DynamoDB query success', { userId, itemsCount: items.length })","","    return {","      statusCode: 200,","      headers: corsHeaders(),","      body: JSON.stringify({ items })","    }","  } catch (error) {","    // Log full error â€” this is the single most usefull place to debug","    logger.error('DynamoDB query failed', {","      message: error.message,","      stack: error.stack,","      code: error.code,","      details: error","    })","","    // Return a safe message to client but keep the logs in cloudwatch","    return {","      statusCode: 500,","      headers: corsHeaders(),","      body: JSON.stringify({ error: 'Could not fetch TODOs', details: error.message })","    }","  }","}","","function corsHeaders() {","  return {","    'Access-Control-Allow-Origin': '*',","    'Access-Control-Allow-Credentials': true","  }","}","","function summarizeEvent(event) {","  try {","    return {","      path: event?.path,","      httpMethod: event?.httpMethod,","      userIdPresent: !!event?.requestContext?.authorizer?.userId,","      principalId: event?.requestContext?.authorizer?.principalId","    }","  } catch {","    return {}","  }","}","","function summarizeParams(params) {","  // Avoid logging huge objects (like full ExpressionAttributeValues with big data)","  return {","    TableName: params.TableName,","    hasKeyCondition: !!params.KeyConditionExpression,","    hasIndex: !!params.IndexName","  }","}",""]}]]},"ace":{"folds":[],"scrolltop":17.333334557804143,"scrollleft":0,"selection":{"start":{"row":11,"column":0},"end":{"row":11,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1763846124872,"hash":"4cb04d170b7a7fee937c78f80775bb4dd7c48218"}